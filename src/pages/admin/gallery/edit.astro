---
import Layout from "@/layouts/Layout.astro";
import galleryData from "@/data/gallery.json";

const id = Astro.url.searchParams.get("id");

const item = galleryData.data.find((item: any) => item.id === id);

if (!item) {
  return Astro.redirect("/admin/gallery");
}
---

<Layout title="Edit Gallery Item">
  <main class="container mx-auto py-10 px-4">
    <div class="mb-6">
      <a 
        href="/admin/gallery"
        class="inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m15 18-6-6 6-6"/>
        </svg>
        Kembali ke Gallery
      </a>
    </div>

    <h1 class="mb-6 text-3xl font-bold">Edit Gallery Item</h1>
    
    <form id="formGallery" class="max-w-2xl mx-auto space-y-6 rounded-lg bg-white p-6 shadow-md dark:bg-gray-800">
      <!-- ID Field -->
      <div>
        <label for="id" class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
          ID
        </label>
        <input 
          type="text" 
          id="id" 
          name="id" 
          value={item.id}
          readonly 
          class="w-full rounded-md border border-gray-300 p-2 bg-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white cursor-not-allowed" 
        />
      </div>

      <!-- Title Field -->
      <div>
        <label for="title" class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
          Title <span class="text-red-500">*</span>
        </label>
        <input 
          type="text" 
          id="title" 
          name="title" 
          value={item.title}
          placeholder="Masukkan judul gallery" 
          required 
          class="w-full rounded-md border border-gray-300 p-2 focus:border-blue-500 focus:ring focus:ring-blue-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white" 
        />
      </div>

      <!-- Description Field -->
      <div>
        <label for="description" class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
          Description <span class="text-red-500">*</span>
        </label>
        <textarea 
          id="description" 
          name="description" 
          placeholder="Masukkan deskripsi" 
          rows="4"
          required
          class="w-full rounded-md border border-gray-300 p-2 focus:border-blue-500 focus:ring focus:ring-blue-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
        >{item.description || ''}</textarea>
      </div>

      <!-- URLs Field (Multiple) -->
      <div>
        <label for="url" class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
          Image URLs <span class="text-red-500">*</span>
        </label>
        <textarea 
          id="url" 
          name="url" 
          placeholder="Masukkan URL gambar, satu per baris&#10;https://example.com/image1.jpg&#10;https://example.com/image2.jpg" 
          required 
          rows="8"
          class="w-full rounded-md border border-gray-300 p-2 font-mono text-sm focus:border-blue-500 focus:ring focus:ring-blue-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
        >{item.url.join('\n')}</textarea>
        <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
          Masukkan satu URL per baris. Minimal 1 URL diperlukan.
        </p>
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-3 pt-4">
        <button 
          type="submit" 
          id="submitBtn"
          class="flex-1 inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary hover:bg-primary/90 text-white h-10 px-4 py-2"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
            <polyline points="17 21 17 13 7 13 7 21"/>
            <polyline points="7 3 7 8 15 8"/>
          </svg>
          Simpan Perubahan
        </button>
        <a 
          href="/admin/gallery"
          class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 border border-gray-300 bg-white hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-600 dark:hover:bg-gray-700 h-10 px-4 py-2"
        >
          Kembali
        </a>
      </div>
    </form>
  </main>
</Layout>

<script>
  document
    .getElementById("formGallery")
    ?.addEventListener("submit", async function (event) {
      event.preventDefault();

      const formData = new FormData(this as HTMLFormElement);
      
      // Get form values
      const id = (formData.get("id") as string).trim();
      const title = (formData.get("title") as string).trim();
      const description = (formData.get("description") as string).trim();
      const urlText = formData.get("url") as string;
      
      // Process URLs - split by newline and clean up
      const url = urlText
        .split('\n')
        .map(u => u.trim())
        .filter(u => u.length > 0);

      // Validation
      if (!id || !title || !description) {
        alert('ID, Title, dan Description wajib diisi!');
        return;
      }

      if (url.length === 0) {
        alert('Minimal 1 URL gambar diperlukan!');
        return;
      }

      // Validate URLs format
      const urlPattern = /^https?:\/\/.+/i;
      const invalidUrls = url.filter(u => !urlPattern.test(u));
      
      if (invalidUrls.length > 0) {
        alert(`URL tidak valid:\n${invalidUrls.join('\n')}`);
        return;
      }

      // Data sesuai dengan API (tanpa category)
      const data = {
        id,
        title,
        description,
        url, // Array of URLs
      };

      console.log("üì§ Data yang akan dikirim:", data);

      const submitBtn = document.getElementById("submitBtn") as HTMLButtonElement;
      const originalText = submitBtn.innerHTML;
      
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
          <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Menyimpan...
        `;
      }

      try {
        const response = await fetch("/api/gallery/update-gallery", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();
        console.log("üì• Response:", result);

        if (response.ok) {
          alert("‚úÖ Item berhasil diupdate!");
          window.location.href = "/admin/gallery";
        } else {
          alert(`‚ùå Gagal update item: ${result.message}`);
          
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
          }
        }
      } catch (error) {
        console.error("üí• Error:", error);
        alert("‚ùå Terjadi kesalahan saat mengupdate item.");
        
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      }
    });
</script>